<project name="Enchanting Plus" basedir="./" default="main">
    
    <!-- Properties -->
    
	<property environment="env" />
    <property name="build.dir"           value="build"/>
	<property name="common.dir"			 value="common" />
	<property name="client.dir"			 value="client" />
	<property name="resource.dir"		 value="resources" />
	<property name="download.dir"		 value="download" />

    <property name="temp.dir"            value="temp" />
    <property name="temp.mcp.dir"        value="${temp.dir}/mcp"/>
    
    <property name="classes.dir"         value="${build.dir}/classes"/>
    <property name="jar.dir"             value="${build.dir}/dist"/>
          
    <property name="mcp.dir"             value="${build.dir}/mcp"/>
      
    <property name="clientsrc.dir"       value="${mcp.dir}/src/minecraft"/>

    <property name="mcp-name"          value="mcp_527" />
    <property name="mcp-download"      value="https://dl.dropbox.com/u/21347544/${mcp-name}.zip" />
    <available property="mcp-exists"   file="${download.dir}/${mcp-name}.zip"/>
    <available property="temp-mcp-dir" file="${temp.mcp.dir}"/>

    <property name="eplus.version"       value="1.12.9"/>

    <target name="clean">
        <delete dir="${build.dir}" />
    </target>
	
	<target name="version-not-provided" unless="env.BUILD_NUMBER">
		<buildnumber/>
	</target>

    <target name="setup" depends="version-not-provided">
		<property name="eplus.version.full"  value="${eplus.version}.${build.number}"/>
      
	     <echo message="Starting build for ${eplus.version.full}"/>
		
		<mkdir dir ="${download.dir}"/>

        <antcall target="downloadFiles"/>

        <antcall target="unzip-files"/>


		<buildnumber/>

    </target>

    <target name="downloadFiles">
        <antcall target="download-mcp"/>
    </target>

    <target name="download-mcp" unless="${mcp-exists}">
        <get dest="${download.dir}">
            <url url="${mcp-download}"/>
        </get>
        <delete dir="${temp.mcp.dir}"/>
    </target>

    <target name="unzip-files">
        <antcall target="unzip-mcp" />
    </target>

    <target name="unzip-mcp">
        <unzip dest="${build.dir}">
            <fileset dir="${download.dir}">
                <include name="${mcp-name}.zip" />
            </fileset>
        </unzip>

        <!--
        <exec dir="${temp.forge.dir}" executable="python">
            <arg value="install.py"/>
        </exec>
        -->
    </target>

    <target name="compile" depends="setup">

        <copy todir="${clientsrc.dir}">
            <fileset dir="${client.dir}" />
            <fileset dir="${common.dir}" />
            <filterset>
                <filter token="BUILD_NUMBER" value="${build.number}" />
            </filterset>
        </copy>

        <exec dir="${mcp.dir}" executable="python">
            <arg value="runtime/recompile.py" />
        </exec>

        <exec dir="${mcp.dir}" executable="python">
            <arg value="runtime/reobfuscate.py" />
        </exec>

		<mkdir dir="${classes.dir}/eplus"/>
        <copy todir="${classes.dir}/eplus">
            <fileset dir="${mcp.dir}/reobf/minecraft/eplus"/>
        </copy>

        <exec dir="" executable="python">
            <arg value="changelog.py" />
        </exec>

        <copy todir="${classes.dir}">
            <fileset dir="${resource.dir}">
                <exclude name="build.xml"/>
				<exclude name="build.number"/>
        	</fileset>
        </copy>

        
    </target>
    
    <target name="package" depends="compile">
        
        <zip destfile="${jar.dir}/EnchantingPlus-${eplus.version.full}-beta.zip" basedir="${classes.dir}"/>
        
    </target>
    
    <target name="main" depends="clean,package"/>

</project>